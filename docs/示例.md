追番日程 Flutter App 功能实现文档，二次开发请看（Flutter + 自托管 Supabase + MCP + DeepSeek）

1. 项目目标与核心功能
名称 Gismis
1.1 产品定位

一款以“追番更新日历/周表”为核心的轻量日程应用，面向动漫/剧集用户，提供：
	•	周一至周日更新排列与个人追番记录
	•	动漫大全（聚合更新信息、平台、封面、更新集数、标题与简介）
	•	自动更新推送（系统抓取/聚合后写入库、客户端展示）
	•	AI 辅助：总结剧情、联网搜索资讯/新闻、给出建议问题（热门话题）
	•	动漫见闻页：原著来源 + AI 总结 + 扩展信息
	•	收藏与自定义排列
	•	个人资料页
	•	登录注册：自建账号体系（不使用 Supabase Auth）

1.2 非目标（建议明确，否则会爆炸）
	•	不做视频在线播放与版权内容分发（只做信息聚合与跳转）
	•	不做平台账号登录（腾讯/爱奇艺/优酷/B站账号体系）
	•	不做弹幕、评论系统（可后续扩展）

⸻

2. 关键合规与数据源策略（务必在开工前定下来）

你要求的数据源：腾讯视频、爱奇艺、优酷、哔哩哔哩。现实问题是：这些平台并不保证提供稳定、允许商用聚合的公开 API。因此建议采用“合规优先”的三层策略：

2.1 数据源分层策略

优先级 A：官方/公开可用接口或开放平台
	•	如果存在开放平台或公开检索接口：优先使用，稳定且合规。

优先级 B：搜索聚合 + 结构化抽取
	•	使用联网搜索获取动漫条目页链接（平台内页面或权威百科/条目）。
	•	后端对页面做结构化抽取（只取封面、标题、更新集数、简介、更新时间、播放平台链接）。
	•	注意：抽取频率、缓存、robots、以及仅存“元数据”。

优先级 C：人工补录兜底
	•	App 允许用户手动创建/编辑条目、更新日、当前集数（确保产品可用性）。
	•	自动数据只是“增强”。

建议：MVP 阶段先做 B + C；待确认可用官方接口后再切到 A。

⸻

3. 总体架构

3.1 客户端（Flutter）
	•	UI：艺术风格（米白/自然色系）+ 艺术字体 + 流畅过渡动画
	•	状态管理：建议 Riverpod（可维护性强）或 Bloc（团队熟悉则可）
	•	路由：go_router
	•	网络：dio
	•	本地缓存：isar 或 hive（MVP 可先 hive）
	•	图片缓存：cached_network_image
	•	动画：flutter_animate / animations（Material motion）+ 自定义 page transition
	•	Markdown 渲染（AI 总结/见闻）：flutter_markdown
	•	流式输出渲染（AI）：SSE/WebSocket/HTTP chunk（详见第 8 章）

3.2 后端（自托管 Supabase）
	•	Postgres + RLS（用于数据隔离）
	•	Storage（封面图建议只缓存“你自有”缩略图；原图使用外链）
	•	Edge Functions（作为你的业务 API 层）
	•	Cron/Job（定时抓取更新、刷新“热门问题”）
	•	MCP（Supabase MCP）用于“AI 助手/开发自动化”创建表、函数、策略、种子数据等

3.3 自建 Auth（不使用 Supabase Auth）
	•	你将自行实现：
	•	注册/登录
	•	密码哈希与盐（bcrypt/argon2）
	•	JWT 签发与刷新（access + refresh）
	•	会话管理（token 黑名单/刷新 token 轮换）
	•	Flutter 端携带 Authorization: Bearer <access_token> 调用你的 Edge Functions
	•	Edge Functions 验证 JWT 后执行 DB 操作（服务端使用 supabase service role 或者使用 Postgres RPC + RLS，二选一）

建议：业务 API 一律走 Edge Functions；客户端不直接用 service role。

⸻

4. 数据模型设计（Postgres）

下面给出一套可落地的表结构（可按你业务再精简/扩展）。

4.1 用户与会话（自建）

app_users
	•	id UUID PK
	•	email text unique
	•	username text unique
	•	password_hash text
	•	avatar_url text nullable
	•	created_at timestamptz
	•	updated_at timestamptz

app_sessions
	•	id UUID PK
	•	user_id UUID FK -> app_users.id
	•	refresh_token_hash text
	•	user_agent text
	•	ip text
	•	expires_at timestamptz
	•	created_at timestamptz
	•	revoked_at timestamptz nullable

refresh token 存 hash，不存明文；刷新时做轮换（rotate）。

4.2 动漫主数据（系统库）

anime
	•	id UUID PK
	•	title text
	•	title_alias text[]（别名/日文名/英文名等）
	•	cover_url text（原始封面外链）
	•	cover_cached_url text nullable（你自己的缩略图地址，可选）
	•	summary text nullable（短简介，系统抓取）
	•	source_type text nullable（原著类型：漫画/小说/原创/游戏等）
	•	source_title text nullable（原著名）
	•	status text（ongoing/finished/hiatus）
	•	created_at timestamptz
	•	updated_at timestamptz

anime_platform
	•	id UUID PK
	•	anime_id UUID FK
	•	platform text（tencent/iqiyi/youku/bilibili/other）
	•	url text（播放页/专题页链接）
	•	region text nullable
	•	created_at timestamptz

anime_release_schedule
	•	id UUID PK
	•	anime_id UUID FK
	•	weekday int（1=Mon … 7=Sun）
	•	update_time time nullable（如果可获取）
	•	timezone text nullable
	•	created_at timestamptz
	•	updated_at timestamptz

anime_episode_state
	•	id UUID PK
	•	anime_id UUID FK
	•	latest_episode int（系统最新集数）
	•	latest_title text nullable（最新一集标题）
	•	latest_brief text nullable（最新一集简介/摘要）
	•	last_checked_at timestamptz
	•	source_platform text nullable
	•	raw_payload jsonb nullable（抓取原始结构化数据，便于追踪）

4.3 用户侧数据（个人追番/收藏/排列）

user_anime_follow
	•	id UUID PK
	•	user_id UUID FK
	•	anime_id UUID FK
	•	progress_episode int（用户已看/追到第几集）
	•	follow_weekday_override int nullable（用户自定义周几更新；为空则用系统）
	•	notes text nullable
	•	is_favorite boolean default false
	•	created_at timestamptz
	•	updated_at timestamptz
	•	unique(user_id, anime_id)

user_weekday_order
	•	id UUID PK
	•	user_id UUID FK
	•	weekday int
	•	anime_ids uuid[]（该日的排序）
	•	updated_at timestamptz
	•	unique(user_id, weekday)

4.4 AI 与内容增强

ai_anime_digest
	•	id UUID PK
	•	anime_id UUID FK
	•	type text（overall/episode/latest_news/source_intro）
	•	content_md text（markdown）
	•	model text（deepseek）
	•	created_at timestamptz

anime_news
	•	id UUID PK
	•	anime_id UUID FK nullable（新闻可关联某部作品，也可泛动漫）
	•	title text
	•	summary text nullable
	•	url text
	•	publisher text nullable
	•	published_at timestamptz nullable
	•	created_at timestamptz

hot_suggested_questions
	•	id UUID PK
	•	topic text（热词/主题）
	•	question text（建议问题）
	•	source text（search/trend/curated）
	•	rank int
	•	generated_at timestamptz
	•	expires_at timestamptz

⸻

5. Row Level Security（RLS）与权限策略

5.1 系统数据 vs 用户数据
	•	anime*、anime_episode_state、anime_news、hot_suggested_questions：系统表
	•	客户端只读（可走 Edge Functions 返回）
	•	写入仅后端任务/管理员
	•	user_*：用户表
	•	必须 RLS：仅 user_id = auth_user_id() 可访问

5.2 自建 Auth 如何对接 RLS？

因为你不使用 Supabase Auth，Postgres 的 auth.uid() 这条链路无法直接用。

两种方式（选其一）：

方案 A（推荐，简单可靠）：不依赖 RLS，所有写操作走 Edge Functions 并由服务端校验 JWT
	•	Edge Functions 使用 service role 访问 DB
	•	在业务层确保 user_id 只能是 token 里的 id
	•	DB 层可以不启用 RLS（或只对 public client key 禁止写）
	•	优点：实现快
	•	缺点：需要你严格保证 API 层正确

方案 B：仍使用 RLS，但通过“Postgres 会话变量 + 安全函数”实现
	•	Edge Function 在每次 DB 事务设置 set_config('app.user_id', '<uuid>', true)
	•	RLS 策略改为比较 current_setting('app.user_id', true)
	•	优点：DB 层更强隔离
	•	缺点：实现复杂，需要确保所有查询都在同一连接/事务上下文

建议：MVP 采用方案 A；稳定后再升级 B。

⸻

6. 后端服务设计（Edge Functions / 自建 API）

6.1 服务模块划分
	1.	auth-service（你自建，可独立容器部署）

	•	POST /auth/register
	•	POST /auth/login
	•	POST /auth/refresh
	•	POST /auth/logout

	2.	api-service（Supabase Edge Functions 或单独 Hono/Node 服务）

	•	动漫库查询
	•	用户追番/收藏/周表排序
	•	AI 流式接口代理（DeepSeek + Search）
	•	新闻/资讯聚合接口
	•	热门问题接口

	3.	crawler-service（定时任务）

	•	平台数据抽取/刷新
	•	新闻抓取/聚合
	•	热门话题生成（结合搜索趋势/资讯）

6.2 API（建议的 REST 设计）

Anime
	•	GET /anime?keyword=&page=&size=
	•	GET /anime/{id}
	•	GET /anime/{id}/platforms
	•	GET /anime/{id}/schedule
	•	GET /anime/{id}/state
	•	GET /schedule/weekday/{1-7}（返回当天系统更新表）

User
	•	GET /me
	•	PATCH /me（头像、昵称、偏好）
	•	GET /me/follow（我追的）
	•	POST /me/follow（关注某动漫，含初始 progress）
	•	PATCH /me/follow/{animeId}（更新 progress、override weekday、收藏）
	•	DELETE /me/follow/{animeId}
	•	GET /me/weekday/{1-7}（我当天列表：系统 + 自定义）
	•	PUT /me/weekday/{1-7}/order（提交排序数组）

AI（独立页面）
	•	GET /ai/suggestions（每次打开页面返回推荐问题列表）
	•	POST /ai/chat/stream（SSE/WS 流式）
	•	输入：messages[]、mode（summary/news/source/qa）、anime_id?

Anime Digest / News
	•	GET /anime/{id}/digest（综合见闻：原著 + AI 总结 + 扩展）
	•	GET /news?anime_id=&keyword=&page=

⸻

7. Flutter 端产品结构与页面设计

7.1 App 导航结构（建议 Bottom Navigation）
	•	首页（动漫大全）
	•	周表（日程）
	•	AI 助手
	•	见闻（可并入详情页 Tab，也可单独）
	•	我的（资料/收藏/设置）

若你想更克制：底部 4 个 Tab：首页 / 周表 / AI / 我的，见闻放进动漫详情页的 Tab。

7.2 首页：动漫大全（系统推送/更新聚合）

核心组件：
	•	顶部搜索框（关键词、别名）
	•	“今日更新”横向卡片（来自 GET /schedule/weekday/{today}）
	•	分区：最近更新、热门、平台推荐
	•	动漫卡片：封面、标题、平台角标、最新集数、最新标题（可折叠简介）

交互：
	•	点卡片 -> 动漫详情页（含：概览/平台/周表/见闻/AI）
	•	卡片右上角：收藏/关注按钮（未登录则引导登录）

7.3 周表（日程）

布局：
	•	顶部：周一到周日 Tabs / 或纵向一周列表
	•	每日列表：优先显示“用户已关注的”，并混入“系统当日更新推荐”（可切换开关）
	•	每条：封面小图 + 标题 + 最新集数 + 用户进度 + 快捷按钮（+1 / 标记已看）

功能：
	•	用户可手动添加本日更新动漫（即设置 override weekday 或临时“今天更新”标记）
	•	排序：长按拖拽（写入 PUT /me/weekday/{}/order）
	•	记录进度：PATCH /me/follow/{animeId}

7.4 AI 助手（独立页面）

要求：
	•	默认 DeepSeek API
	•	支持联网搜索能力（由你后端实现“搜索 -> 摘要 -> 回答”的工具链）
	•	流式输出：并且“字段模糊流式输出效果”
	•	每次进入页面：拉取“建议问题”（热门话题），点击自动提问

UI 建议：
	•	顶部：建议问题 chips（横滑）
	•	中部：对话消息流
	•	底部：输入框 + 模式切换（总结/资讯/原著/自由问答）
	•	流式渲染区：对单条 AI 消息采用“逐字出现 + 字段渐进解锁”的视觉

7.5 动漫详情页（含见闻）

建议做成 4 个 Tab：
	•	概览（封面、简介、平台、周几更新、最新集）
	•	追番（关注/进度/提醒）
	•	见闻（原著来源 + AI 总结 + 扩展信息）
	•	AI（针对该作品的一键总结/问答）

⸻

8. AI 流式输出设计（字段模糊流式）

8.1 “字段模糊流式”是什么意思（工程化定义）

你要的不是普通逐字流式，而是：
	•	后端先输出一个结构化框架（JSON fields）
	•	前端先渲染“字段占位骨架”，再让字段内容逐步填充
	•	字段填充时，先以“模糊态”显示（blur/opacity），随后“清晰化”

8.2 推荐的协议：SSE（Server-Sent Events）

原因：
	•	Flutter 实现简单
	•	适合文本流
	•	不需要双向通道（输入一次，输出流式）

8.3 SSE 事件格式（建议）

事件类型：
	•	meta：返回 message_id、模型、模式等
	•	field_start：开始一个字段（例如 summary）
	•	delta：字段增量文本
	•	field_end：字段结束
	•	done：完成

示例（逻辑示意）：
	•	meta: { message_id, fields: ["title","summary","key_points","news"] }
	•	field_start: { field:"summary" }
	•	delta: { field:"summary", text:"本集讲述了..." }
	•	field_end: { field:"summary" }
	•	field_start: { field:"key_points" }
	•	delta: { field:"key_points", text:"1) ...\n2) ..." }
	•	done

8.4 Flutter 端渲染策略
	•	每条 AI 消息对应一个 AiResponseModel：
	•	title, summary, keyPoints, news, sources 等字段
	•	每个字段有状态：hidden / blurred / clear / completed
	•	UI：
	•	字段 start 时：从 skeleton -> blurred（opacity 0.5 + blur）
	•	接收 delta：逐字追加，同时保持 blurred
	•	field_end：过渡到 clear（去 blur + opacity 1）
	•	动画实现：
	•	AnimatedOpacity + BackdropFilter（blur）
	•	或用 flutter_animate 做更顺滑的过渡

8.5 “联网搜索能力”实现（后端工具链）

你后端实现一个“工具执行器”：
	1.	接收用户问题
	2.	执行搜索（你选用的搜索提供商/聚合接口）
	3.	取前 N 条结果，抓取摘要（注意缓存与限频）
	4.	将摘要作为上下文喂给 DeepSeek
	5.	DeepSeek 生成结构化字段输出（JSON schema 或你自定义的字段流协议）

⸻

9. 热门建议问题（每次打开 AI 页自动推荐）

9.1 生成方式
	•	定时任务每 30~60 分钟刷新一次 hot_suggested_questions
	•	数据来源：
	•	动漫资讯/新闻聚合的热词统计
	•	搜索趋势（可选）
	•	站内行为（收藏/点击最多的作品关键词）

9.2 API
	•	GET /ai/suggestions：
	•	返回 top 10：[{topic, question, rank}]
	•	Flutter 端：
	•	页面 init 时请求
	•	以 chips 展示，点击即把该 question 送入 POST /ai/chat/stream

⸻

10. 动漫数据抓取与更新系统

10.1 抓取目标字段
	•	标题、封面图链接
	•	最新集数、最新集标题、简略信息
	•	更新日（周几）、可能的更新时间
	•	播放平台与页面链接

10.2 定时任务策略
	•	每天全量刷新：低频（比如凌晨）
	•	白天增量刷新：按“正在连载且热度高/用户关注多”的列表高频刷新
	•	对每部作品设置 last_checked_at，避免重复抓取

10.3 缓存策略
	•	抓取结果写入 anime_episode_state.raw_payload
	•	封面图：
	•	直接使用外链可快速上线
	•	若你担心外链失效或跨域：后端做缩略图缓存到 Supabase Storage（仅缩略图）

⸻

11. UI 视觉风格与组件规范（艺术风、休闲色）

11.1 色彩与材质建议
	•	背景：米白/自然纸张色（浅暖灰、奶油白）
	•	卡片：轻微阴影 + 纸张纹理（可用淡噪点背景图）
	•	强调色：低饱和“橄榄绿/陶土橘/雾蓝”作为点缀（不刺眼）
	•	分割线：极浅灰，避免强对比

11.2 字体
	•	中文艺术体要注意可读性：标题可艺术体，正文用更清晰的字体
	•	建议：
	•	标题：艺术体（你选一个可商用的字体文件打包到 assets）
	•	正文：常规字体（如 Noto Sans CJK / 思源黑体类）
	•	规范：标题字号更大、行距更松，形成“杂志感”

11.3 动画与过渡
	•	页面切换：共享元素（封面图 Hero）+ 淡入上滑
	•	卡片展开：使用 AnimatedContainer + SizeTransition
	•	AI 输出：字段 skeleton -> blur -> clear 的渐进动画

⸻

12. Flutter 工程结构（建议）

lib/
  app/
    app.dart
    router.dart
    theme/
      theme.dart
      typography.dart
  core/
    network/
      dio_client.dart
      api_exception.dart
      sse_client.dart
    storage/
      local_cache.dart
    utils/
      debounce.dart
      format.dart
  features/
    home/
      data/
      domain/
      ui/
    schedule/
      data/
      domain/
      ui/
    anime_detail/
      data/
      domain/
      ui/
    ai/
      data/
      domain/
      ui/
    profile/
      data/
      domain/
      ui/
  shared/
    widgets/
    models/
    constants/
assets/
  fonts/
  images/


⸻

13. 开发里程碑与任务拆解（按可交付推进）

Phase 0：项目初始化（1~2 天）
	•	Flutter 工程搭建、路由、主题、字体、基础动画框架
	•	网络层（Dio + interceptors）
	•	本地缓存（Hive/Isar）

Phase 1：账号体系（3~5 天）
	•	自建 Auth 服务（register/login/refresh/logout）
	•	Flutter 登录注册页、Token 管理、自动刷新
	•	后端 JWT 验证中间件（Edge Function or API service）

Phase 2：动漫大全 + 详情（5~10 天）
	•	anime 表与基础查询 API
	•	首页列表、搜索、详情页
	•	平台链接展示与跳转

Phase 3：周表（日程）+ 关注进度（5~10 天）
	•	user_anime_follow / user_weekday_order
	•	周表 UI、拖拽排序、进度更新
	•	系统更新与用户关注混排逻辑

Phase 4：AI 助手（7~14 天）
	•	GET /ai/suggestions
	•	POST /ai/chat/stream SSE 流式
	•	字段模糊流式渲染
	•	针对作品的一键总结/新闻问答

Phase 5：自动更新与新闻（持续迭代）
	•	crawler-service：更新集数、新闻抓取
	•	hot questions 生成
	•	缓存与限频

⸻

14. MCP（Supabase MCP）在本项目中的使用方式

你希望“后端使用 supabase mcp 来创建后端”。落地建议：

14.1 MCP 的职责定位
	•	用 MCP 自动生成/维护：
	•	数据表 DDL
	•	索引、约束
	•	种子数据
	•	Edge Function 模板
	•	RLS 策略（如果你选方案 B）
	•	MCP 不建议直接承载业务逻辑运行时（运行时仍是 Edge Functions / 你的服务）

14.2 推荐工作流
	1.	你写“数据库变更需求”（如新增表、字段）
	2.	让 AI 通过 Supabase MCP 生成迁移脚本
	3.	在 CI/CD 中执行迁移
	4.	生成/更新对应的 API 合约与 Flutter DTO

⸻

15. 风险点与工程建议（避免后期返工）
	1.	平台数据源稳定性：先做“可用的聚合”，不要把产品可用性赌在某个平台接口上。必须有人工补录兜底。
	2.	自建 Auth 的安全性：密码哈希、刷新 token 轮换、限流、防爆破要做最低限度。
	3.	AI 成本与缓存：对“动漫见闻/总结”做结果缓存（ai_anime_digest），避免每次都重新调用。
	4.	SSE 在移动网络下的健壮性：断线重连、消息 id、partial state 恢复需要设计好。
	5.	图片与性能：封面列表必须做缓存与占位 skeleton，避免滚动掉帧。

⸻


